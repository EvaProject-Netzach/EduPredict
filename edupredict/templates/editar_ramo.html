{% extends "base/base.html" %}

{% block titulo %}
    Editar Ramo: {{ user.username }}
{% endblock %}

{% block contenido %}

<div class="card mx-auto text-center" style="max-width: 700px;">
    <div class="card-body">
        <h2 class="mb-5">Editar Ramo</h2>

        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <h5>Nombre del ramo</h5>
                <input type="text" name="nombre" class="form-control mb-5 w-50 d-block mx-auto" required value="{{ ramo.nombre }}">
            </div>

            <h5>Notas</h5>
            <div id="notas-container" class="text-center"></div>

            <button type="button" id="add-nota" class="btn btn-sm btn-info mb-5">+ Añadir nota</button>
            
            <h5>Examen</h5>
            <div id="examen-container" class="text-center"></div>

            <button type="button" id="toggle-examen" class="btn btn-sm btn-warning mb-5">
                Añadir examen
            </button>

            <button class="btn btn-info w-50 d-block mx-auto">Guardar Cambios</button>
        </form>
    </div>
</div>

<script>
let notasData = {{ ramo.notas|safe }};
let examenData = {{ ramo.examen|safe }};
let notaCount = 0;
let examenAdded = examenData && Object.keys(examenData).length > 0;

// Función para añadir nota
function agregarNota(nota_val="", porc_val="") { 
    notaCount++;
    let div = document.createElement("div");
    div.classList.add("mb-2", "d-flex", "gap-2", "justify-content-center");
    
    // Si viene vacío, dejar el campo vacío; si es 0, mostrar 0
    let notaValue = nota_val === "" ? "" : nota_val;
    let porcValue = porc_val === "" ? "" : porc_val;
    
    div.innerHTML = `
        <input type="number" step="0.1" min="0" max="7" name="nota_${notaCount}" placeholder="Nota" class="form-control" style="width:110px;" value="${notaValue}">
        <input type="number" step="0.1" min="0" max="100" name="porc_${notaCount}" placeholder="%" class="form-control" style="width:110px;" value="${porcValue}">
        <button type="button" class="btn btn-danger btn-sm remove-nota">-</button>
    `;
    document.getElementById("notas-container").appendChild(div);

    div.querySelector(".remove-nota").addEventListener("click", function(){
        div.remove();
    });
}

// Cargar notas existentes
if (notasData && notasData.length > 0) {
    notasData.forEach(n => {
        let nota_val = (n.nota !== null && n.nota !== undefined) ? n.nota : "";
        let porc_val = (n.porcentaje !== null && n.porcentaje !== undefined) ? n.porcentaje : "";
        agregarNota(nota_val, porc_val);
    });
}

// Añadir nota vacía
document.getElementById("add-nota").addEventListener("click", function(){
    agregarNota("", "");
});

// Manejar examen
let examenContainer = document.getElementById("examen-container");
let toggleBtn = document.getElementById("toggle-examen");

if (examenAdded) {
    let notaExamen = (examenData.nota !== null && examenData.nota !== undefined) ? examenData.nota : "";
    let porcExamen = (examenData.porcentaje !== null && examenData.porcentaje !== undefined) ? examenData.porcentaje : "";
    
    examenContainer.innerHTML = `
        <div class="mb-2 d-flex gap-2 justify-content-center">
            <input type="number" step="0.1" min="0" max="7" name="examen_nota" placeholder="Nota" class="form-control" style="width:110px;" value="${notaExamen}">
            <input type="number" step="0.1" min="0" max="100" name="examen_porcentaje" placeholder="%" class="form-control" style="width:110px;" value="${porcExamen}">
        </div>
    `;
    toggleBtn.textContent = "Eliminar examen";
}

toggleBtn.addEventListener("click", function(){
    if(!examenAdded){
        examenContainer.innerHTML = `
            <div class="mb-2 d-flex gap-2 justify-content-center">
                <input type="number" step="0.1" min="0" max="7" name="examen_nota" placeholder="Nota" class="form-control" style="width:110px;" value="">
                <input type="number" step="0.1" min="0" max="100" name="examen_porcentaje" placeholder="%" class="form-control" style="width:110px;" value="">
            </div>
        `;
        this.textContent = "Eliminar examen";
        examenAdded = true;
    } else {
        examenContainer.innerHTML = "";
        this.textContent = "Añadir examen";
        examenAdded = false;
    }
});

// Si no hay notas, agregar una vacía por defecto
if (!notasData || notasData.length === 0) {
    agregarNota("", "");
}
</script>

{% endblock %}